<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆåŠŸç‡ç®—å‡ºå›â…¡</title>
<style>
body{font-family: system-ui, -apple-system;background:#1e1e2f;color:#fff;margin:0;padding:6px;box-sizing:border-box}
h1{text-align:center;font-size:18px;margin:4px 0}
.description{text-align:center;font-size:13px;margin-bottom:6px;line-height:1.4;white-space:pre-line}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.box{border:2px solid #fff;border-radius:8px;padding:4px;text-align:center}
.box h2{margin:0 0 4px;font-size:14px}
.buttons{display:flex;flex-direction:column;gap:4px}
button{border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.success{background:#ff9933;height:48px;font-size:14px}
.miss{background:#66ccff;height:48px;font-size:14px}
.box .footer{margin-top:4px}
.box .value{font-size:12px}
.box .rate{font-size:18px;font-weight:bold}
.box .ci{font-size:11px;color:#ffeeaa}
.totalBox{margin-top:4px;border:2px solid #fff;border-radius:8px;padding:6px;text-align:center;background:#2b2b44}
.totalRate{font-size:22px;font-weight:bold}
.totalCI{font-size:12px;color:#ffeeaa}
.resetSound{display:flex;gap:6px;margin-top:4px}
.reset{background:#ff6666;flex:1;height:38px;font-size:14px}
.soundToggle{background:#66dd88;width:90px;height:38px;font-size:13px}
.optionalSection{background:#264653;border-radius:10px;padding:8px;margin-top:6px}
.formSection input{width:100%;height:36px;font-size:15px;margin-bottom:6px;border-radius:6px;border:2px solid #fff;background:#1e1e2f;color:#fff;padding:4px;box-sizing:border-box}
.targetRow{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.csvSection{display:flex;align-items:center;gap:6px;margin-top:6px}
.csvBtn{height:40px;font-size:14px;border-radius:8px;border:none;background:#b399ff;color:#000;padding:0 8px;cursor:pointer}
.memoSection{margin-top:6px}
.memoSection textarea{width:100%;height:56px;font-size:14px;border:none;background:#1e1e2f;color:#fff;resize:none}
</style>
</head>
<body>

<h1>æˆåŠŸç‡ç®—å‡ºå›â…¡</h1>
<div class="description">
æˆåŠŸ/ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆåŠŸç‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚
ABCD4ä½“åŒæ™‚ã«æˆåŠŸç‡ã®è¨ˆç®—ãŒå¯èƒ½ã§ã™ã€‚
</div>

<div class="grid" id="grid"></div>

<div class="totalBox">
  <div>ABCD åˆè¨ˆ</div>
  <div>æˆåŠŸï¼š<span id="ts">0</span> ï¼ ãƒŸã‚¹ï¼š<span id="tm">0</span></div>
  <div class="totalRate" id="totalRate">0.0%</div>
  <div class="totalCI" id="totalCI">0.0 - 0.0%</div>
</div>

<div class="resetSound">
  <button class="reset" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³ON</button>
</div>

<div class="optionalSection">
  <p style="font-size:13px;">
    ãƒ‡ãƒ¼ã‚¿æä¾›ã«ã”å”åŠ›ã„ãŸã ã‘ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’å…¥åŠ›ã€â‘  CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ â‘¡ ãƒ‡ãƒ¼ã‚¿æä¾›å…ˆã®Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
  </p>

  <div class="formSection">
    <input id="playerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (ä»»æ„)">
    <input id="userLevel" placeholder="è¡“è€…ãƒ¬ãƒ™ãƒ«">

    <div class="targetRow">
      <input id="targetA" placeholder="A å¯¾è±¡Lv">
      <input id="targetB" placeholder="B å¯¾è±¡Lv">
      <input id="targetC" placeholder="C å¯¾è±¡Lv">
      <input id="targetD" placeholder="D å¯¾è±¡Lv">
    </div>

    <input id="skillName" placeholder="æŠ€å(æ­£å¼åç§°)">
  </div>

  <div class="csvSection">
    <button class="csvBtn" onclick="downloadCSV()">â‘  CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <span style="font-size:16px;">â†’</span>
    <button class="csvBtn" style="background:#aa88ff;"
      onclick="window.open('https://drive.google.com/drive/folders/1tYpywXZoB33LoSDLk98yfL351-uwfmdf','_blank')">
      â‘¡ ãƒ‡ãƒ¼ã‚¿æä¾›ã¯ã‚³ãƒãƒ©ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ãŒé–‹ãã¾ã™ï¼‰
    </button>
  </div>

  <div class="memoSection">
    <textarea id="memo" placeholder="ãƒ¡ãƒ¢æ¬„"></textarea>
  </div>
</div>

<script>
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let soundOn=true;
function playTone(f,d=0.1,v=0.25){if(!soundOn)return;const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.frequency.value=f; g.gain.value=v;o.connect(g); g.connect(audioCtx.destination);o.start(); o.stop(audioCtx.currentTime+d);}
function playOK(){playTone(880);}
function playNG(){playTone(440);}
function toggleSound(){soundOn=!soundOn;document.querySelector(".soundToggle").textContent=soundOn?"ğŸ”Š éŸ³ON":"ğŸ”‡ éŸ³OFF";}

const labels=["A","B","C","D"];
const data={};
const grid=document.getElementById("grid");

labels.forEach(l=>{
  data[l]={s:0,m:0};
  const box=document.createElement("div");
  box.className="box";
  box.innerHTML=`
    <h2>${l}</h2>
    <div class="buttons">
      <button class="success" onclick="add('${l}',1)">æˆåŠŸ</button>
      <button class="miss" onclick="add('${l}',0)">ãƒŸã‚¹</button>
    </div>
    <div class="footer">
      <div class="value">æˆåŠŸï¼š0 ï¼ ãƒŸã‚¹ï¼š0</div>
      <div class="rate">0.0%</div>
      <div class="ci">0.0 - 0.0%</div>
    </div>`;
  grid.appendChild(box);
  data[l].el=box;
});

// Wilsonã‚¹ã‚³ã‚¢æ³•é–¢æ•°
function wilsonCI(s, n, z=1.96){
  if(n===0) return [0,0];
  const p = s/n;
  const denom = 1 + (z*z)/n;
  const center = p + (z*z)/(2*n);
  const margin = z * Math.sqrt((p*(1-p)/n) + (z*z)/(4*n*n));
  const lower = (center - margin)/denom;
  const upper = (center + margin)/denom;
  return [Math.max(0, lower*100), Math.min(100, upper*100)];
}

function add(l,succ){
  succ ? data[l].s++ : data[l].m++;
  succ ? playOK() : playNG();
  update(l);
  updateTotal();
}

function update(l){
  const d=data[l], t=d.s+d.m;
  const r=t ? (d.s/t*100).toFixed(1) : "0.0";
  const [lci,uci] = wilsonCI(d.s,t);
  const f=d.el.querySelector(".footer");
  f.children[0].textContent=`æˆåŠŸï¼š${d.s} ï¼ ãƒŸã‚¹ï¼š${d.m}`;
  f.children[1].textContent=`${r}%`;
  f.children[2].textContent=`${lci.toFixed(1)} - ${uci.toFixed(1)}%`;
}

function updateTotal(){
  let s=0,m=0;
  labels.forEach(l=>{s+=data[l].s; m+=data[l].m;});
  const t=s+m;
  document.getElementById("ts").textContent=s;
  document.getElementById("tm").textContent=m;
  document.getElementById("totalRate").textContent=t?(s/t*100).toFixed(1)+"%":"0.0%";
  const [lci,uci] = wilsonCI(s,t);
  document.getElementById("totalCI").textContent=`${lci.toFixed(1)} - ${uci.toFixed(1)}%`;
}

function resetAll(){
  playNG();
  labels.forEach(l=>{data[l].s=0;data[l].m=0;update(l);});
  updateTotal();
  ["playerName","userLevel","targetA","targetB","targetC","targetD","skillName","memo"]
    .forEach(id=>document.getElementById(id).value="");
}

function downloadCSV(){
  const name=document.getElementById("playerName").value;
  const userLv=parseInt(document.getElementById("userLevel").value)||0;
  const skill=document.getElementById("skillName").value;
  const memo=document.getElementById("memo").value;
  const now=new Date().toLocaleString();

  const rows=[["ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å","è¡“è€…Lv","å¯¾è±¡Lv","ãƒ¬ãƒ™ãƒ«å·®","æˆåŠŸ","ãƒŸã‚¹","æˆåŠŸç‡","æŠ€å","ãƒ¡ãƒ¢","åŒºåˆ†","å‡ºåŠ›æ—¥æ™‚"]];
  labels.forEach(l=>{
    const d=data[l], t=d.s+d.m;
    const target=parseInt(document.getElementById("target"+l).value)||0;
    const rate=t?((d.s/t*100).toFixed(2))+"%":"0%";
    rows.push([name,userLv,target,userLv-target,d.s,d.m,rate,skill,memo,l,now]);
  });

  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="æˆåŠŸç‡ç®—å‡ºçµæœ_ABCDåˆ¥.csv";
  a.click();
}
</script>

</body>
</html>
