<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆåŠŸç‡ç®—å‡ºå›</title>
<style>
body{
  font-family: system-ui, -apple-system;
  background:#1e1e2f;
  color:#fff;
  margin:0;
  padding:8px;
}

h1{
  text-align:center;
  font-size:18px;
  margin-bottom:4px;
}

/* èª¬æ˜æ–‡ */
.description{
  text-align:center;
  font-size:13px;
  margin-bottom:8px;
  line-height:1.4;
  white-space:pre-line;
}

/* ===== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ===== */
.mainButtons{
  display:flex;
  flex-direction:column;
  gap:8px;
}

button{
  font-weight:bold;
  border-radius:10px;
  border:none;
  color:#000;
}

.success,.miss{
  height:72px;
  font-size:18px;
}

.success{background:#ff9933;}
.miss{background:#66ccff;}

.reset{background:#ff6666;height:48px;flex:1;}
.soundToggle{background:#66dd88;height:48px;width:90px;font-size:14px;}

/* ===== CSV & ãƒ‡ãƒ¼ã‚¿æä¾› ===== */
.csvSection{
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:6px;
}

.csvBtn{
  height:46px;
  font-size:14px;
  border-radius:10px;
  border:none;
  background:#b399ff;
  color:#000;
  padding:0 8px;
  cursor:pointer;
}

/* ===== å…¥åŠ›æ¬„ ===== */
.inputSection{
  border:2px solid #fff;
  border-radius:10px;
  padding:8px;
  margin:6px 0;
}

.inputBox{
  width:100%;
  height:38px;
  font-size:18px;
  text-align:right;
  border-radius:6px;
  border:2px solid #fff;
  background:#1e1e2f;
  color:#fff;
  margin-bottom:6px;
  box-sizing:border-box;
}

/* ===== ãƒ†ãƒ³ã‚­ãƒ¼ ===== */
.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}

.keypad button{
  height:40px;
  font-size:16px;
  background:#bbb;
  border-radius:6px;
}

/* ===== çµæœ ===== */
.footer{
  background:#2b2b44;
  padding:8px;
  border-radius:8px;
  text-align:center;
}

.value{font-size:14px}
.rate{font-size:24px;font-weight:bold}
.ci{font-size:12px;color:#ffeeaa}

/* ===== ãƒªã‚»ãƒƒãƒˆ+éŸ³ ===== */
.resetSoundWrapper{
  display:flex;
  gap:6px;
  margin:6px 0;
}

/* ===== ä»»æ„å…¥åŠ› ===== */
.optionalSection{
  background:#264653;
  border-radius:10px;
  padding:8px;
  margin-top:6px;
}

.formSection{margin:0;padding:6px;}
.formSection input{
  width:100%;
  height:38px;
  font-size:16px;
  margin-bottom:6px;
  border-radius:6px;
  border:2px solid #fff;
  background:#1e1e2f;
  color:#fff;
  padding:4px;
  box-sizing:border-box;
}

.memoSection{
  margin-top:6px;
}

.memoSection textarea{
  width:100%;
  height:56px;
  font-size:14px;
  border:none;
  background:#1e1e2f;
  color:#fff;
  resize:none;
  box-sizing:border-box;
}
</style>
</head>
<body>
<h1>æˆåŠŸç‡ç®—å‡ºå›</h1>
<div class="description">
æˆåŠŸ/ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆåŠŸç‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚
ã¾ãŸã€ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å¾Œã«æˆåŠŸ/ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä»»æ„å›æ•°ã®è¨ˆç®—ã‚‚å¯èƒ½ã§ã™ã€‚
</div>

<div class="mainButtons">
  <button class="success" onclick="addSuccess()">æˆåŠŸ</button>
  <button class="miss" onclick="addMiss()">ãƒŸã‚¹</button>
</div>

<div class="inputSection">
  <input id="inputValue" class="inputBox" readonly placeholder="æ•°å€¤å…¥åŠ›">
  <div class="keypad">
    <button onclick="addNum(1)">1</button>
    <button onclick="addNum(2)">2</button>
    <button onclick="addNum(3)">3</button>
    <button onclick="addNum(4)">4</button>
    <button onclick="addNum(5)">5</button>
    <button onclick="addNum(6)">6</button>
    <button onclick="addNum(7)">7</button>
    <button onclick="addNum(8)">8</button>
    <button onclick="addNum(9)">9</button>
    <button onclick="clearNum()">C</button>
    <button onclick="addNum(0)">0</button>
    <button onclick="backspace()">â†</button>
  </div>
</div>

<div class="footer">
  <div class="value">æˆåŠŸï¼š<span id="success">0</span></div>
  <div class="value">ãƒŸã‚¹ï¼š<span id="miss">0</span></div>
  <div class="rate">æˆåŠŸç‡ï¼š<span id="rate">0.0</span>%</div>
  <div class="ci">95% ä¿¡é ¼åŒºé–“ï¼š<span id="ci">0.0 - 0.0</span>%</div>
</div>

<div class="resetSoundWrapper">
  <button class="reset" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³ON</button>
</div>

<!-- ä»»æ„å…¥åŠ› -->
<div class="optionalSection">
  <p style="font-size:13px;">ãƒ‡ãƒ¼ã‚¿æä¾›ã«ã”å”åŠ›ã„ãŸã ã‘ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã‚’å…¥åŠ›ã—ã€â‘ csvãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â†’â‘¡ãƒ‡ãƒ¼ã‚¿æä¾›å…ˆã®Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
  <div class="formSection">
    <input id="playerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (ä»»æ„)">
    <input id="userLevel" placeholder="è¡“è€…ãƒ¬ãƒ™ãƒ«">
    <input id="targetLevel" placeholder="å¯¾è±¡ãƒ¬ãƒ™ãƒ«">
    <input id="skillName" placeholder="æŠ€å(æ­£å¼åç§°)">
  </div>

  <!-- CSV & ãƒ‡ãƒ¼ã‚¿æä¾›ãƒœã‚¿ãƒ³ -->
  <div class="csvSection">
    <button class="csvBtn" onclick="downloadCSV()">â‘  CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <span style="align-self:center;font-size:16px;">â†’</span>
    <button class="csvBtn" style="background:#aa88ff;"
            onclick="window.open('https://drive.google.com/drive/folders/1tYpywXZoB33LoSDLk98yfL351-uwfmdf','_blank')">
      â‘¡ ãƒ‡ãƒ¼ã‚¿æä¾›ã¯ã‚³ãƒãƒ©ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰
    </button>
  </div>

  <div class="memoSection">
    <textarea id="memo" placeholder="ãƒ¡ãƒ¢æ¬„"></textarea>
  </div>
</div>

<script>
/* ===== éŸ³ ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let soundOn=true;
function playTone(f,d=0.1,v=0.25){if(!soundOn)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d);}
function ok(){playTone(880,0.12,0.3);}
function ng(){playTone(440,0.12,0.25);}
function toggleSound(){soundOn=!soundOn; document.querySelector(".soundToggle").textContent=soundOn?"ğŸ”Š éŸ³ON":"ğŸ”‡ éŸ³OFF";}

/* ===== ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ===== */
let success=0, miss=0;
const inputValue=document.getElementById("inputValue");
const successEl=document.getElementById("success");
const missEl=document.getElementById("miss");
const rate=document.getElementById("rate");
const ci=document.getElementById("ci");
const memo=document.getElementById("memo");

function getVal(){return Number(inputValue.value)||1;}

function update(){
  const t=success+miss;
  rate.textContent=t?(success/t*100).toFixed(1):"0.0";
  if(!t){ci.textContent="0.0 - 0.0";return;}
  const p=success/t,se=Math.sqrt(p*(1-p)/t);
  ci.textContent=`${Math.max(0,(p-1.96*se)*100).toFixed(1)} - ${Math.min(100,(p+1.96*se)*100).toFixed(1)}`;
}

function addSuccess(){ok(); success+=getVal(); successEl.textContent=success; update(); clearNum();}
function addMiss(){ng(); miss+=getVal(); missEl.textContent=miss; update(); clearNum();}
function resetAll(){
  ng();
  success=miss=0;
  successEl.textContent=0;
  missEl.textContent=0;
  update();
  clearNum();
  memo.value="";
  document.getElementById("playerName").value="";
  document.getElementById("userLevel").value="";
  document.getElementById("targetLevel").value="";
  document.getElementById("skillName").value="";
}

/* ===== ãƒ†ãƒ³ã‚­ãƒ¼ ===== */
function addNum(n){inputValue.value+=n;}
function clearNum(){inputValue.value="";}
function backspace(){inputValue.value=inputValue.value.slice(0,-1);}

/* ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ===== */
function downloadCSV(){
  const playerName=document.getElementById("playerName").value;
  const userLevel=parseInt(document.getElementById("userLevel").value)||0;
  const targetLevel=parseInt(document.getElementById("targetLevel").value)||0;
  const skillName=document.getElementById("skillName").value;
  const levelDiff=userLevel-targetLevel;
  const total=success+miss;
  const successRate=total>0?((success/total*100).toFixed(2))+"%":"0%";
  const now=new Date().toLocaleString();

  const csvData=[
    ["ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å","è¡“è€…ãƒ¬ãƒ™ãƒ«","å¯¾è±¡ãƒ¬ãƒ™ãƒ«","ãƒ¬ãƒ™ãƒ«å·®","æˆåŠŸ","ãƒŸã‚¹","æˆåŠŸç‡","æŠ€å(æ­£å¼åç§°)","ãƒ¡ãƒ¢","å‡ºåŠ›æ—¥æ™‚"],
    [playerName,userLevel,targetLevel,levelDiff,success,miss,successRate,skillName,memo.value,now]
  ];

  const csvContent=csvData.map(e=>e.join(",")).join("\n");
  const blob=new Blob([csvContent],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="æˆåŠŸç‡ç®—å‡ºçµæœ.csv";
  a.click();
}
</script>
</body>
</html>
