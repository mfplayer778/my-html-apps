<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆåŠŸç‡ç®—å‡ºå› + CSVå‡ºåŠ›</title>

<style>
body {
  font-family: system-ui, -apple-system;
  background: #1e1e2f;
  color: #fff;
  margin: 0;
  padding: 12px;
}

h1 {
  text-align: center;
  margin-bottom: 10px;
  font-size: 20px;
}

/* ===== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ===== */
.mainButtons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 6px;
}

button {
  font-weight: bold;
  border-radius: 10px;
  border: none;
  color: #000;
}

.success { background: #ff9933; height: 55px; font-size:17px; width:100%; }
.miss { background: #66ccff; height: 55px; font-size:17px; width:100%; }
.reset { background: #ff6666; height: 55px; font-size:16px; flex-grow:1; }
.soundToggle { background: #66dd88; height: 55px; font-size:16px; width:90px; }
.csv { background: #cdaeff; height: 50px; font-size:16px; width:100%; margin-top:6px; border-radius:10px; }

button:active { opacity:0.7; }

/* ===== èª¬æ˜æ–‡ ===== */
.helpText {
  font-size: 14px;
  line-height: 1.4;
  opacity: 0.85;
  margin: 6px 0 10px;
}

/* ===== å…¥åŠ›æ¬„ ===== */
.inputSection {
  border: 2px solid #fff;
  border-radius: 10px;
  padding: 8px;
  margin-bottom: 10px;
}

.inputBox {
  width: 100%;
  height: 38px;
  font-size: 17px;
  text-align: right;
  border-radius: 6px;
  border:1px solid #fff;
  background: #1e1e2f;
  color: #fff;
  margin-bottom: 6px;
}

/* ===== ãƒ†ãƒ³ã‚­ãƒ¼ ===== */
.keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5px;
}

.keypad button {
  height: 40px;
  font-size: 17px;
  background: #bbbbbb;
  border-radius: 6px;
}

/* ===== ãƒªã‚»ãƒƒãƒˆ+éŸ³ ===== */
.resetSoundWrapper {
  display:flex;
  gap:6px;
  margin-top:6px;
  flex-wrap: nowrap; 
  align-items:center;
}

/* ===== ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆæˆåŠŸç‡çµæœï¼‰ ===== */
.footer {
  background: #2b2b44;
  padding: 12px;
  border-radius: 8px;
  margin-top:6px;
  text-align: center;
}

.value { font-size:18px; margin:4px 0; }
.rate { font-size:30px; font-weight:bold; margin-top:5px; }
.ci { font-size:15px; margin-top:4px; color:#ffeeaa; }

/* ===== ãƒ¡ãƒ¢æ¬„ ===== */
.memoSection {
  border: 2px solid #fff;
  border-radius: 10px;
  padding: 6px;
  margin-top: 12px; /* ä¸€ç•ªä¸‹ã« */
}

.memoSection textarea {
  width: 100%;
  height: 90px;
  font-size: 17px;
  border: none;
  background: #1e1e2f;
  color: #fff;
  resize: vertical;
  padding: 6px;
  border-radius: 6px;
  box-sizing: border-box;
}

@media (max-width: 400px) {
  .success, .miss, .reset, .soundToggle, .csv { height: 50px; font-size:16px; }
  .inputBox { height: 36px; font-size:16px; }
  .keypad button { height:36px; font-size:16px; }
  .memoSection textarea { height:70px; font-size:16px; }
  .rate { font-size:26px; }
  .ci { font-size:14px; }
}
</style>
</head>

<body>
<h1>æˆåŠŸç‡ç®—å‡ºå› + CSVå‡ºåŠ›</h1>

<div class="mainButtons">
  <button class="success" onclick="addSuccess()">æˆåŠŸ</button>
  <button class="miss" onclick="addMiss()">ãƒŸã‚¹</button>
</div>

<div class="helpText">
  æˆåŠŸ/ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆåŠŸç‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚<br>
  ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å¾Œã«æˆåŠŸ/ãƒŸã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä»»æ„å›æ•°ã‹ã‚‰å†è¨ˆç®—ã‚‚ã§ãã¾ã™ã€‚
</div>

<div class="inputSection">
  <input id="inputValue" class="inputBox" type="text" placeholder="æ•°å€¤å…¥åŠ›" readonly>
  <div class="keypad">
    <button onclick="addNum(1)">1</button>
    <button onclick="addNum(2)">2</button>
    <button onclick="addNum(3)">3</button>
    <button onclick="addNum(4)">4</button>
    <button onclick="addNum(5)">5</button>
    <button onclick="addNum(6)">6</button>
    <button onclick="addNum(7)">7</button>
    <button onclick="addNum(8)">8</button>
    <button onclick="addNum(9)">9</button>
    <button onclick="clearNum()">C</button>
    <button onclick="addNum(0)">0</button>
    <button onclick="backspace()">â†</button>
  </div>
</div>

<!-- æˆåŠŸç‡çµæœã‚’ãƒ†ãƒ³ã‚­ãƒ¼ã®ä¸‹ã« -->
<div class="footer">
  <div class="value">æˆåŠŸå›æ•°ï¼š<span id="success">0</span></div>
  <div class="value">ãƒŸã‚¹å›æ•°ï¼š<span id="miss">0</span></div>
  <div class="rate">æˆåŠŸç‡ï¼š<span id="rate">0.0</span>%</div>
  <div class="ci">95% ä¿¡é ¼åŒºé–“ï¼š<span id="ci">0.0 - 0.0</span>% â†ã“ã®ç¯„å›²ã«çœŸå€¤ãŒã‚ã‚‹ãƒ§</div>
</div>

<div class="resetSoundWrapper">
  <button class="reset" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³ON</button>
</div>

<div>
  <button class="csv" onclick="exportCSV()">CSVå‡ºåŠ›</button>
</div>

<div class="memoSection">
  <textarea id="memo" placeholder="ãƒ¡ãƒ¢æ¬„ï¼šè‡ªç”±ã«æ›¸ãè¾¼ã¿å¯èƒ½"></textarea>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let soundOn = true;

function playTone(freq,duration=0.1,volume=0.25){if(!soundOn)return; const osc=audioCtx.createOscillator(); const gain=audioCtx.createGain(); osc.frequency.value=freq; gain.gain.value=volume; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+duration);}
function playSuccessSound(){playTone(880,0.12,0.3);}
function playMinusSound(){playTone(440,0.12,0.25);}
function toggleSound(){soundOn=!soundOn; document.querySelector(".soundToggle").textContent = soundOn?"ğŸ”Š éŸ³ON":"ğŸ”‡ éŸ³OFF";}

let success=0, miss=0;

function getInputValue(){return Number(document.getElementById("inputValue").value)||1;}

function updateRate(){
  const total=success+miss;
  const rate = total===0?0:(success/total*100).toFixed(1);
  document.getElementById("rate").textContent = rate;
  updateCI();
}

function updateCI(){
  const total = success+miss;
  if(total===0){ document.getElementById("ci").textContent="0.0 - 0.0"; return; }
  const p = success/total;
  const SE = Math.sqrt(p*(1-p)/total);
  const lower = Math.max(0,(p - 1.96*SE)*100).toFixed(1);
  const upper = Math.min(100,(p + 1.96*SE)*100).toFixed(1);
  document.getElementById("ci").textContent = `${lower} - ${upper}`;
}

function addSuccess(){ playSuccessSound(); success+=getInputValue(); document.getElementById("success").textContent=success; updateRate(); clearNum();}
function addMiss(){ playMinusSound(); miss+=getInputValue(); document.getElementById("miss").textContent=miss; updateRate(); clearNum();}
function resetAll(){ playMinusSound(); success=0; miss=0; document.getElementById("success").textContent=0; document.getElementById("miss").textContent=0; updateRate(); clearNum(); document.getElementById("memo").value="";}

function addNum(n){ document.getElementById("inputValue").value+=n; }
function clearNum(){ document.getElementById("inputValue").value=""; }
function backspace(){ const v=document.getElementById("inputValue").value; document.getElementById("inputValue").value=v.slice(0,-1); }

function exportCSV(){
  const total=success+miss;
  const rate = total===0?0:(success/total*100).toFixed(1);
  const SE = Math.sqrt((success/total)*(1-(success/total))/total||0);
  const lower = Math.max(0,(success/total - 1.96*SE)*100).toFixed(1);
  const upper = Math.min(100,(success/total + 1.96*SE)*100).toFixed(1);
  let csv="æˆåŠŸå›æ•°,ãƒŸã‚¹å›æ•°,æˆåŠŸç‡,95%ä¿¡é ¼åŒºé–“\n";
  csv+=`${success},${miss},${rate},"${lower} - ${upper}"\n\n`;
  csv+=`ãƒ¡ãƒ¢,"${document.getElementById("memo").value.replace(/"/g,'""')}"\n`;
  csv+=`å‡ºåŠ›æ—¥æ™‚,${new Date().toLocaleString()}\n`;
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'æˆåŠŸç‡ç®—å‡ºçµæœ.csv';
  a.click();
}
</script>
</body>
</html>
